From 5fb7a1dbc0110c677f6d182876b3507b07058dd4 Mon Sep 17 00:00:00 2001
From: Michal Hrusecky <michal.hrusecky@turris.com>
Date: Wed, 13 Oct 2021 14:47:29 +0200
Subject: [PATCH] atlas-support: Add new package with Ripe Atlas support files

---
 hardware/mox/atlas-support/Makefile       | 44 +++++++++++++++++++++++
 hardware/mox/atlas-support/files/boot.txt |  1 +
 2 files changed, 45 insertions(+)
 create mode 100644 hardware/mox/atlas-support/Makefile
 create mode 120000 hardware/mox/atlas-support/files/boot.txt

diff --git a/hardware/mox/atlas-support/Makefile b/hardware/mox/atlas-support/Makefile
new file mode 100644
index 000000000..60fe71677
--- /dev/null
+++ b/hardware/mox/atlas-support/Makefile
@@ -0,0 +1,44 @@
+#
+## Copyright (C) 2021 CZ.NIC z.s.p.o. (https://www.nic.cz/)
+#
+## This is free software, licensed under the GNU General Public License v3.
+# See /LICENSE for more information.
+#
+
+include $(TOPDIR)/rules.mk
+include $(INCLUDE_DIR)/kernel.mk
+
+PKG_NAME:=atlas-support
+PKG_VERSION:=$(LINUX_VERSION)-$(LINUX_RELEASE)-$(LINUX_VERMAGIC)
+PKG_RELEASE:=1
+PKG_MAINTAINER:=CZ.NIC <packaging@turris.cz>
+PKG_BUILD_DIR:=$(KERNEL_BUILD_DIR)/packages
+PKG_BUILD_DEPENDS:=linux
+
+include $(INCLUDE_DIR)/package.mk
+
+define Package/atlas-support
+  TITLE:=Support files for Ripe Atlas
+  DEPENDS:=@TARGET_mvebu_cortexa53_DEVICE_ripe-atlas
+endef
+
+define Package/atlas-support/description
+ Contains device tree and boot script for Ripe Atlas.
+endef
+
+define Build/Prepare
+	mkdir -p $(PKG_BUILD_DIR)
+endef
+
+define Build/Compile
+	sed 's|armada-3720-turris-mox.dtb|armada-3720-ripe-atlas.dtb|' files/boot.txt > $(PKG_BUILD_DIR)/boot.txt
+	$(KERNEL_MAKE) Image dtbs
+endef
+
+define Package/atlas-support/install
+	$(INSTALL_DIR) $(1)/boot
+	$(CP) $(LINUX_DIR)/arch/$(LINUX_KARCH)/boot/dts/marvell/armada-3720-ripe-atlas.dtb "$(1)"/boot
+	mkimage -T script -C none -n boot -d $(PKG_BUILD_DIR)/boot.txt "$(1)"/boot/boot.scr
+endef
+
+$(eval $(call BuildPackage,atlas-support))
diff --git a/hardware/mox/atlas-support/files/boot.txt b/hardware/mox/atlas-support/files/boot.txt
new file mode 120000
index 000000000..5d4ba8bbb
--- /dev/null
+++ b/hardware/mox/atlas-support/files/boot.txt
@@ -0,0 +1 @@
+../../mox-support/files/boot.txt
\ No newline at end of file
-- 
2.33.1

